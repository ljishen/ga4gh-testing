# Directory Structure
#
# Server:
#   - {{ volume_host_dir }}/srv/data:   For All Server Data
# Master:
#   - {{ file_server_dir }}/{{ test_results_folder_name }}/server_{{ server_commit_hash }}/{{ locust_folder_name }}/{{ locustfile_commit_hash }}:    For Locust Stats File
#   - {{ file_server_dir }}/{{ test_results_folder_name }}/server_{{ server_commit_hash }}/{{ compliance_folder_name }}/{{ compliance_test_suite_commit_hash }}:    For Compliance Tests Results
#   - {{ volume_host_dir }}/{{ test_results_folder_name }}/{{ locust_folder_name }}:    For Locust Stats File and Log File

- name: Install Docker on Server
  any_errors_fatal: true
  hosts: all
  become: yes
  roles:
    - { role: angstwad.docker_ubuntu, when: check_docker }

- name: Deploy GA4GH Reference Server
  hosts: server
  become: yes

  vars:
    server_volume_host_dir: "{{ volume_host_dir }}/srv/data"
    server_image_name: "macieksmuga/ga4gh-server-m2:docker2"
    registry_db_filename: registry.db

  pre_tasks:
    - stat: path={{ server_volume_host_dir }}/{{ registry_db_filename }}
      register: registry_db

  roles:
    - { role: create_registry, when: recreate_registry_db or not registry_db.stat.exists }
    - { role: server, when: deploy_server }

- name: Query Server Latest Source Code Commit Hash
  hosts: server
  become: yes
  gather_facts: no
  tasks:
    - name: Query Server Container ID
      command: docker ps -aqfl name={{ server_container_name }}
      register: server_container_id

    - name: Query Commit Hash
      command: docker exec {{ server_container_id.stdout }} git -C /srv/ga4gh/server log -1 --pretty=format:%H
      register: commit_hash

- name: Run Compliance Test Suite
  hosts: master
  become: yes
  gather_facts: no
  
  vars:
    server_commit_hash: "{{ hostvars[groups['server'][0]]['commit_hash']['stdout'] }}"

  roles:
    - { role: compliance_tests }

- name: Run Locust Testing
  hosts: locust
  become: yes
  gather_facts: no

  vars:
    num_slaves: "{{ groups.slave | length }}"
    container_name: "locust"
    locustfile_url: https://raw.githubusercontent.com/ljishen/ga4gh-testing/master/load-testing/locustfile.py 

  pre_tasks:
    - name: Query Commit Hash of locustfile.py
    - name: Ensure locustfile Directory Exists
      file: path={{ volume_host_dir }}/{{ locust_folder_name }} state=directory
    - name: Download locustfile
      get_url: url={{ locustfile_url }} dest={{ volume_host_dir }}/{{ locust_folder_name }}/{{ locust_filename }} force=yes
      when: locustfile_url is defined

  roles:
    - { role: locust_standalone, when: num_slaves | int == 0 }
    - { role: locust_distributed, when: num_slaves | int != 0 }

- name: Copy Locust Stats File to File Server Directory
  hosts: master
  become: yes
  gather_facts: no
  
  vars:
    server_commit_hash: "{{ hostvars[groups['server'][0]]['commit_hash']['stdout'] }}"
 
  tasks:
    - block:
        - name: Ensure Destination Directory Exists
          file:
            path: "{{ file_server_dir }}/{{ test_results_folder_name }}/server_{{ server_commit_hash }}/{{ locust_folder_name }}"
            state: directory
        - name: Copy Stats File
          command: >
              cp -p {{ volume_host_dir }}/{{ test_results_folder_name }}/{{ locust_folder_name }}/{{ locust_stats_filename }}
                {{ file_server_dir }}/{{ test_results_folder_name }}/server_{{ server_commit_hash }}/{{ locust_folder_name }}
      when: groups.slave | length == 0
